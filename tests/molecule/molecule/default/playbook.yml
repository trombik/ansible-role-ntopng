---

- name: Coverage
  hosts: all
  pre_tasks:
    - name: Dump all hostvars
      debug:
        var: hostvars[inventory_hostname]
  post_tasks:
    - name: List all services (systemd)
      # workaround ansible-lint: [303] service used in place of service module
      shell: "echo; systemctl list-units --type service"
      changed_when: false
      when:
        # in docker, init is not systemd
        - ansible_virtualization_type != 'docker'
        - ansible_os_family == 'RedHat' or ansible_os_family == 'Debian'
    - name: list all services (FreeBSD service)
      # workaround ansible-lint: [303] service used in place of service module
      shell: "echo; service -l"
      changed_when: false
      when:
        - ansible_os_family == 'FreeBSD'
    - name: list all services (rcctl)
      command: "rcctl ls all"
      changed_when: false
      when:
        - ansible_os_family == 'OpenBSD'
  roles:
    - role: docker
      when:
        - ansible_virtualization_type == 'docker'
    - role: trombik.redis
    - role: ansible-role-ntopng
  vars:
    redis_config:
      databases: 16
      save 900: 1
    os_ntopng_flags:
      OpenBSD: ""
      FreeBSD: "ntopng_flags='{{ ntopng_config_file }}'"
      Debian: ""
      RedHat: ""
    ntopng_flags: "{{ os_ntopng_flags[ansible_os_family] }}"
    ntopng_extra_groups:
      - bin
    ntopng_config: |
      {% if ansible_os_family == 'Debian' %}
      -e=
      --data-dir={{ ntopng_db_dir }}
      --user={{ ntopng_user }}
      {% endif %}
      --http-port=:3000
      --disable-login=1
